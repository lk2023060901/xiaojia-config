# Luban 复合类型配置说明

## 概述

Luban 支持三种复合类型：`list`（列表）、`map`（字典）、`set`（集合）。本文档详细说明如何在 Excel 和 `__beans__.xlsx` 中配置这些类型。

---

## 一、List 类型（列表）

### 1.1 基本语法

```
(list#sep=分隔符),元素类型
```

### 1.2 配置示例

#### 在 `__beans__.xlsx` 中定义

| Bean | Field | Type |
|------|-------|------|
| Item | skill_ids | `(list#sep=\|),int` |
| Item | tags | `(list#sep=\|),string` |
| Reward | items | `(list#sep=;),RewardItem` |

#### 在 Excel 数据文件中填写

| id | skill_ids | tags | items |
|----|-----------|------|-------|
| 1001 | `1\|2\|3` | `consumable\|potion` | `1001:10;1002:5` |
| 1002 | `1001` | `equipment\|sword` | `2001:1` |
| 1003 | `` | `` | `` |

**说明：**
- 使用指定的分隔符（如 `|` 或 `;`）分隔多个元素
- 空单元格表示空列表
- 单个元素也需要配置分隔符（虽然不会实际使用）

### 1.3 常用分隔符

| 分隔符 | 配置写法 | Excel 示例 | 说明 |
|--------|----------|------------|------|
| 竖线 \| | `(list#sep=\|),int` | `1\|2\|3` | **推荐**，不与常见符号冲突 |
| 分号 ; | `(list#sep=;),int` | `1;2;3` | 适合嵌套场景 |
| 逗号 , | `(list#sep=,),int` | `1,2,3` | 常用但容易混淆 |
| # 号 | `(list#sep=\#),int` | `1#2#3` | **需要转义** `\#` |
| & 号 | `(list#sep=\&),int` | `1&2&3` | **需要转义** `\&` |

⚠️ **注意**：`#` 和 `&` 字符被用作 Luban 的特殊标记，必须使用 `\#` 和 `\&` 转义。

### 1.4 嵌套 List

```
type="(list#sep=;),(list#sep=,),int"
```

**Excel 填写：**
```
1,2,3;4,5,6;7,8,9
```

**解析结果：**
```go
[][]int{
    {1, 2, 3},
    {4, 5, 6},
    {7, 8, 9},
}
```

---

## 二、Map 类型（字典）

### 2.1 基本语法

```
map,键类型,值类型
```

⚠️ **Map 必须配合 `sep` 使用**，通过字段名上的 `#sep=分隔符` 指定。

### 2.2 配置示例

#### 在 `__beans__.xlsx` 中定义

| Bean | Field | Type |
|------|-------|------|
| Item | attributes | `map,string,int` |
| Shop | prices | `map,int,int` |
| Config | params | `map,string,string` |

#### Excel 数据文件中字段名需要添加 `#sep=`

**Excel 表头（Row 1）：**
```
##  | id   | attributes#sep=,  | prices#sep=;
```

**Excel 数据（Row 3+）：**

| id | attributes#sep=, | prices#sep=; |
|----|------------------|--------------|
| 1001 | `hp,100,mp,50,atk,20` | `1;100;2;200` |
| 1002 | `hp,200,def,30` | `1;150` |

**解析结果：**
```go
// Item 1001
attributes: map[string]int{
    "hp": 100,
    "mp": 50,
    "atk": 20,
}
prices: map[int]int{
    1: 100,
    2: 200,
}
```

### 2.3 Map 的填写规则

格式：`key1,value1,key2,value2,key3,value3`

- 使用分隔符分隔 **键值对**
- 每个键值对内部：**先写 key，再写 value**
- 示例：`1,100,2,200,3,300` → `{1: 100, 2: 200, 3: 300}`

---

## 三、Set 类型（集合）

### 3.1 基本语法

```
(set#sep=分隔符),元素类型
```

### 3.2 配置示例

#### 在 `__beans__.xlsx` 中定义

| Bean | Field | Type |
|------|-------|------|
| Item | required_items | `(set#sep=,),int` |
| Quest | unlocked_areas | `(set#sep=;),string` |

#### 在 Excel 数据文件中填写

| id | required_items | unlocked_areas |
|----|----------------|----------------|
| 5001 | `1001,1002,1003` | `area1;area2;area3` |
| 5002 | `2001` | `area4` |

**说明：**
- Set 与 List 填写方式相同
- 区别在于 Set 会**自动去重**
- 示例：`1,2,2,3` → `{1, 2, 3}`

---

## 四、复合类型组合

### 4.1 List 嵌套结构体

```xml
<!-- 定义结构体，指定 sep -->
<bean name="RewardItem" sep=":">
    <var name="item_id" type="int"/>
    <var name="count" type="int"/>
</bean>
```

**在 `__beans__.xlsx` 中：**

| Bean | Field | Type |
|------|-------|------|
| Reward | items | `(list#sep=;),RewardItem` |

**Excel 填写：**
```
1001:10;1002:5;2003:1
```

**解析为：**
```go
[]RewardItem{
    {ItemId: 1001, Count: 10},
    {ItemId: 1002, Count: 5},
    {ItemId: 2003, Count: 1},
}
```

### 4.2 Map 嵌套结构体

```xml
<bean name="ItemAttr" sep=":">
    <var name="name" type="string"/>
    <var name="value" type="int"/>
</bean>
```

**在 `__beans__.xlsx` 中：**

| Bean | Field | Type |
|------|-------|------|
| Item | attrs | `map,int,ItemAttr` |

**Excel 字段名（需要 sep）：**
```
attrs#sep=;
```

**Excel 填写：**
```
1;hp:100;2;mp:50
```

**解析为：**
```go
map[int]ItemAttr{
    1: {Name: "hp", Value: 100},
    2: {Name: "mp", Value: 50},
}
```

---

## 五、实战示例

### 示例1：道具的多技能配置

**`__beans__.xlsx` 定义：**

| full_name | field name | type | comment |
|-----------|------------|------|---------|
| Item | use_skill_ids | `(list#sep=\|),int` | 使用时触发的技能列表 |

**Item.xlsx 数据：**

| id | name | use_skill_ids |
|----|------|---------------|
| 1001 | 生命药水 | `5001` |
| 1002 | 魔法药水 | `5002\|5003` |
| 5001 | 技能书 | `6001\|6002\|6003` |

### 示例2：礼包道具配置

**`__beans__.xlsx` 定义：**

| full_name | field name | type | comment |
|-----------|------------|------|---------|
| GiftPack | rewards | `(list#sep=\|),RewardItem` | 奖励列表 |

**Defines 中定义 RewardItem：**
```xml
<bean name="RewardItem" sep=":">
    <var name="item_id" type="int" comment="道具ID"/>
    <var name="count" type="int" comment="数量"/>
</bean>
```

**GiftPack.xlsx 数据：**

| id | name | rewards |
|----|------|---------|
| 10001 | 新手礼包 | `1001:10\|1002:5\|3001:1000` |
| 10002 | 高级礼包 | `2003:1\|3002:100` |

### 示例3：商店的价格配置（Map）

**`__beans__.xlsx` 定义：**

| full_name | field name | type | comment |
|-----------|------------|------|---------|
| Shop | vip_prices | `map,int,int` | VIP等级对应的价格 |

**Shop.xlsx 表头：**
```
##  | id   | name      | vip_prices#sep=,
```

**Shop.xlsx 数据：**

| id | name | vip_prices#sep=, |
|----|------|------------------|
| 1 | 道具商店 | `0,100,1,90,2,80,3,70` |
| 2 | 神秘商店 | `0,200,1,180` |

**解析结果：**
```go
// Shop 1
VipPrices: map[int]int{
    0: 100,  // 普通玩家 100 金币
    1: 90,   // VIP1 九折
    2: 80,   // VIP2 八折
    3: 70,   // VIP3 七折
}
```

---

## 六、最佳实践

### ✅ 推荐做法

1. **优先使用 `|` 作为分隔符**
   ```
   (list#sep=|),int  ✓ 清晰，不易混淆
   ```

2. **嵌套时使用不同分隔符**
   ```
   外层用 ; 内层用 ,
   (list#sep=;),(Vec#sep=,)  ✓
   ```

3. **Map 字段名必须加 sep**
   ```
   字段名: vip_prices#sep=,  ✓
   类型:   map,int,int
   ```

4. **结构体定义 sep 在 XML**
   ```xml
   <bean name="Vec" sep=",">  ✓
   ```

### ❌ 避免做法

1. **忘记转义特殊字符**
   ```
   (list#sep=#),int  ✗ 错误，应该是 \#
   ```

2. **Map 忘记在字段名上加 sep**
   ```
   字段名: prices        ✗ 错误
   应该:  prices#sep=,  ✓
   ```

3. **混用相同分隔符**
   ```
   (list#sep=,),(Vec#sep=,)  ✗ 难以解析
   (list#sep=;),(Vec#sep=,)  ✓ 清晰
   ```

---

## 七、总结对比

| 类型 | 语法 | 字段名是否需要 sep | Excel 示例 |
|------|------|-------------------|------------|
| **List** | `(list#sep=\|),int` | ❌ 不需要 | `1\|2\|3` |
| **Map** | `map,int,int` | ✅ **需要** | `1,100,2,200` |
| **Set** | `(set#sep=,),string` | ❌ 不需要 | `a,b,c` |

**记忆技巧：**
- List/Set：分隔符在**类型定义**上
- Map：分隔符在**字段名**上

---

## 附录：完整示例

参考 Luban 官方示例：
- `/Volumes/work/code/tools/luban_examples-main/DataTables/Datas/test/test_sep.xlsx` - sep 分隔符示例
- `/Volumes/work/code/tools/luban_examples-main/DataTables/Datas/test/test_map.xlsx` - Map 示例
- `/Volumes/work/code/tools/luban_examples-main/DataTables/Datas/test/test_set.xlsx` - Set 示例
